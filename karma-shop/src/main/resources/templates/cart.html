<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layout}">
<head>
    <title>Home</title>
</head>

<body>
<div layout:fragment="content">
    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Shopping Cart</h1>
                    <nav class="d-flex align-items-center">
                        <a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="category.html">Cart</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->

    <!--================Cart Area =================-->
    <section class="cart_area">
        <div class="container">
            <div class="cart_inner">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col">Product</th>
                            <th scope="col">Price</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Total</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cartItem : ${cartItems}" th:data-product-id="${cartItem.id}">
                            <td>
                                <div class="media">
                                    <div class="d-flex">
                                        <img th:src="${cartItem.imageUrl}" alt="">
                                    </div>
                                    <div class="media-body">
                                        <p th:text="${cartItem.name}">Minimalistic shop for multipurpose use</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <h5 th:text="'$' + ${#numbers.formatDecimal(cartItem.price, 1, 2)}">$360.00</h5>
                            </td>
                            <td>
                                <div class="product_count">
                                    <input type="text" name="qty" th:value="${cartItem.quantity}" 
                                           class="input-text qty quantity-input"
                                           maxlength="12" value="1" title="Quantity:" data-item-id="${cartItem.id}">
                                    <button onclick="increaseQuantity(this); return false;"
                                            class="increase items-count" type="button"><i
                                            class="lnr lnr-chevron-up"></i></button>
                                    <button onclick="decreaseQuantity(this); return false;"
                                            class="reduced items-count" type="button"><i
                                            class="lnr lnr-chevron-down"></i></button>
                                </div>
                            </td>
                            <td>
                                <h5 class="item-total" th:text="'$' + ${#numbers.formatDecimal(cartItem.getTotal(), 1, 2)}">$720.00</h5>
                            </td>
                            <td>
                                <button onclick="removeFromCart(this)" class="btn btn-sm btn-danger" title="Remove item">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <tr class="bottom_button">
                            <td>
                                <a class="gray_btn" href="#" onclick="updateCart(); return false;">Update Cart</a>
                            </td>
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <!-- Coupon not applied - show form -->
                                <div th:if="${appliedCouponCode == null}" class="cupon_text d-flex align-items-center">
                                    <form th:action="@{/coupon/apply}" method="post" class="d-flex align-items-center">
                                        <input type="text" name="code" placeholder="Enter Coupon Code" required>
                                        <button type="submit" class="primary-btn">Apply</button>
                                    </form>
                                </div>
                                <!-- Coupon applied - show remove option -->
                                <div th:if="${appliedCouponCode != null}" class="cupon_applied d-flex align-items-center">
                                    <span class="text-success" style="margin-right: 15px;">
                                        <i class="fa fa-check-circle"></i> 
                                        Coupon <strong th:text="${appliedCouponCode}"></strong> applied!
                                    </span>
                                    <form th:action="@{/coupon/remove}" method="post">
                                        <button type="submit" class="gray_btn">Remove</button>
                                    </form>
                                </div>
                                <!-- Flash messages -->
                                <div th:if="${couponSuccess}" class="alert alert-success" style="margin-top: 10px;">
                                    <span th:text="${couponSuccess}"></span>
                                </div>
                                <div th:if="${couponError}" class="alert alert-danger" style="margin-top: 10px;">
                                    <span th:text="${couponError}"></span>
                                </div>
                            </td>
                        </tr>
                        <!-- Discount row - only show when coupon is applied -->
                        <tr th:if="${appliedCouponCode != null}">
                            <td></td>
                            <td></td>
                            <td><h5>Discount (<span th:text="${appliedCouponCode}"></span>)</h5></td>
                            <td><h5 class="text-success" th:text="'-$' + ${#numbers.formatDecimal(discountAmount, 1, 2)}">-$0.00</h5></td>
                        </tr>
                        <tr>
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <h5>Subtotal</h5>
                            </td>
                            <td>
                                <h5 id="subtotal" th:text="'$' + ${#numbers.formatDecimal(cartTotal, 1, 2)}">$2160.00</h5>
                            </td>
                        </tr>
                        <!-- Final Total after discount -->
                        <tr th:if="${appliedCouponCode != null}">
                            <td></td>
                            <td></td>
                            <td><h5><strong>Total</strong></h5></td>
                            <td><h5><strong th:text="'$' + ${#numbers.formatDecimal(finalTotal, 1, 2)}">$0.00</strong></h5></td>
                        </tr>
                        <tr class="shipping_area">
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <h5>Shipping</h5>
                            </td>
                            <td>
                                <div class="shipping_box">
                                    <ul class="list">
                                        <li><a href="#">Flat Rate: $5.00</a></li>
                                        <li><a href="#">Free Shipping</a></li>
                                        <li><a href="#">Flat Rate: $10.00</a></li>
                                        <li class="active"><a href="#">Local Delivery: $2.00</a></li>
                                    </ul>
                                    <h6>Calculate Shipping <i class="fa fa-caret-down" aria-hidden="true"></i></h6>
                                    <select class="shipping_select">
                                        <option value="1">Bangladesh</option>
                                        <option value="2">India</option>
                                        <option value="4">Pakistan</option>
                                    </select>
                                    <select class="shipping_select">
                                        <option value="1">Select a State</option>
                                        <option value="2">Select a State</option>
                                        <option value="4">Select a State</option>
                                    </select>
                                    <input type="text" placeholder="Postcode/Zipcode">
                                    <a class="gray_btn" href="#">Update Details</a>
                                </div>
                            </td>
                        </tr>
                        <tr class="out_button_area">
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>

                            </td>
                            <td>
                                <div class="checkout_btn_inner d-flex align-items-center">
                                    <a class="gray_btn" href="/">Continue Shopping</a>
                                    <a class="primary-btn" href="/checkout">Proceed to checkout</a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    <!--================End Cart Area =================-->
</div>

<script>
// Increase quantity
function increaseQuantity(button) {
    const productCount = button.closest('.product_count');
    const quantityInput = productCount.querySelector('.quantity-input');
    let quantity = parseInt(quantityInput.value) || 0;
    quantity++;
    quantityInput.value = quantity;
    updateItemTotal(button);
}

// Decrease quantity
function decreaseQuantity(button) {
    const productCount = button.closest('.product_count');
    const quantityInput = productCount.querySelector('.quantity-input');
    let quantity = parseInt(quantityInput.value) || 1;
    if (quantity > 1) {
        quantity--;
        quantityInput.value = quantity;
        updateItemTotal(button);
    }
}

// Update item total when quantity changes
function updateItemTotal(element) {
    const row = element.closest('tr');
    const priceText = row.querySelector('td:nth-child(2) h5').textContent;
    const price = parseFloat(priceText.replace('$', ''));
    const quantityInput = row.querySelector('.quantity-input');
    const quantity = parseInt(quantityInput.value) || 1;
    const total = (price * quantity).toFixed(2);
    
    const totalElement = row.querySelector('.item-total');
    if (totalElement) {
        totalElement.textContent = '$' + total;
    }
    updateSubtotal();
}

// Remove item from cart
function removeFromCart(button) {
    if (confirm('Bu ürünü sepetten çıkarmak istediğinize emin misiniz?')) {
        const row = button.closest('tr');
        const productId = row.getAttribute('data-product-id');
        
        // Send delete request to backend
        fetch('/cart/remove/' + productId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
            }
        })
        .then(response => {
            if (response.ok) {
                row.style.opacity = '0.5';
                setTimeout(() => {
                    row.remove();
                    updateSubtotal();
                }, 300);
            } else {
                alert('Hata: Ürün silinirken hata oluştu');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Still remove from UI even if backend call fails
            row.remove();
            updateSubtotal();
        });
    }
}

// Update cart (save quantity changes)
function updateCart() {
    // Get all updated quantities
    const updatedItems = [];
    document.querySelectorAll('.quantity-input').forEach(input => {
        const row = input.closest('tr');
        const productId = row.getAttribute('data-product-id');
        const quantity = parseInt(input.value);
        
        if (quantity > 0) {
            updatedItems.push({
                productId: productId,
                quantity: quantity
            });
        }
    });
    
    // Send update to backend
    fetch('/api/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(updatedItems)
    })
    .then(response => {
        if (response.ok) {
            alert('Cart updated successfully!');
            updateSubtotal();
        } else {
            alert('Error updating cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating cart');
    });
}

// Update subtotal
function updateSubtotal() {
    let subtotal = 0;
    document.querySelectorAll('.item-total').forEach(element => {
        const value = parseFloat(element.textContent.replace('$', ''));
        subtotal += value;
    });
    
    const subtotalElement = document.getElementById('subtotal');
    if (subtotalElement) {
        subtotalElement.textContent = '$' + subtotal.toFixed(2);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSubtotal();
});
</script>
</body>
</html>